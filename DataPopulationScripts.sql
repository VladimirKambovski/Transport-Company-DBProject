INSERT INTO country  VALUES
(1,'Afghanistan','AF'),
(2,'Aland Islands','AX'),
(3,'Albania','AL'),
(4,'Algeria','DZ'),
(5,'American Samoa','AS'),
(6,'Andorra','AD'),
(7,'Angola','AO'),
(8,'Anguilla','AI'),
(9,'Antarctica','AQ'),
(10,'Antigua and Barbuda','AG'),
(11,'Argentina','AR'),
(12,'Armenia','AM'),
(13,'Aruba','AW'),
(14,'Australia','AU'),
(15,'Austria','AT'),
(16,'Azerbaijan','AZ'),
(17,'Bahamas','BS'),
(18,'Bahrain','BH'),
(19,'Bangladesh','BD'),
(20,'Barbados','BB'),
(21,'Belarus','BY'),
(22,'Belgium','BE'),
(23,'Belize','BZ'),
(24,'Benin','BJ'),
(25,'Bermuda','BM'),
(26,'Bhutan','BT'),
(27,'Bolivia','BO'),
(28,'Bonaire, Sint Eustatius and Saba','BQ'),
(29,'Bosnia and Herzegovina','BA'),
(30,'Botswana','BW'),
(31,'Bouvet Island','BV'),
(32,'Brazil','BR'),
(33,'British Indian Ocean Territory','IO'),
(34,'Brunei','BN'),
(35,'Bulgaria','BG'),
(36,'Burkina Faso','BF'),
(37,'Burundi','BI'),
(38,'Cambodia','KH'),
(39,'Cameroon','CM'),
(40,'Canada','CA'),
(41,'Cape Verde','CV'),
(42,'Cayman Islands','KY'),
(43,'Central African Republic','CF'),
(44,'Chad','TD'),
(45,'Chile','CL'),
(46,'China','CN'),
(47,'Christmas Island','CX'),
(48,'Cocos (Keeling) Islands','CC'),
(49,'Colombia','CO'),
(50,'Comoros','KM'),
(51,'Congo','CG'),
(52,'Cook Islands','CK'),
(53,'Costa Rica','CR'),
(54,'Ivory Coast','CI'),
(55,'Croatia','HR'),
(56,'Cuba','CU'),
(57,'Curacao','CW'),
(58,'Cyprus','CY'),
(59,'Czech Republic','CZ'),
(60,'Democratic Republic of the Congo','CD'),
(61,'Denmark','DK'),
(62,'Djibouti','DJ'),
(63,'Dominica','DM'),
(64,'Dominican Republic','DO'),
(65,'Ecuador','EC'),
(66,'Egypt','EG'),
(67,'El Salvador','SV'),
(68,'Equatorial Guinea','GQ'),
(69,'Eritrea','ER'),
(70,'Estonia','EE'),
(71,'Ethiopia','ET'),
(72,'Falkland Islands (Malvinas)','FK'),
(73,'Faroe Islands','FO'),
(74,'Fiji','FJ'),
(75,'Finland','FI'),
(76,'France','FR'),
(77,'French Guiana','GF'),
(78,'French Polynesia','PF'),
(79,'French Southern Territories','TF'),
(80,'Gabon','GA'),
(81,'Gambia','GM'),
(82,'Georgia','GE'),
(83,'Germany','DE'),
(84,'Ghana','GH'),
(85,'Gibraltar','GI'),
(86,'Greece','GR'),
(87,'Greenland','GL'),
(88,'Grenada','GD'),
(89,'Guadaloupe','GP'),
(90,'Guam','GU'),
(91,'Guatemala','GT'),
(92,'Guernsey','GG'),
(93,'Guinea','GN'),
(94,'Guinea-Bissau','GW'),
(95,'Guyana','GY'),
(96,'Haiti','HT'),
(97,'Heard Island and McDonald Islands','HM'),
(98,'Honduras','HN'),
(99,'Hong Kong','HK'),
(100,'Hungary','HU'),
(101,'Iceland','IS'),
(102,'India','IN'),
(103,'Indonesia','ID'),
(104,'Iran','IR'),
(105,'Iraq','IQ'),
(106,'Ireland','IE'),
(107,'Isle of Man','IM'),
(108,'Israel','IL'),
(109,'Italy','IT'),
(110,'Jamaica','JM'),
(111,'Japan','JP'),
(112,'Jersey','JE'),
(113,'Jordan','JO'),
(114,'Kazakhstan','KZ'),
(115,'Kenya','KE'),
(116,'Kiribati','KI'),
(117,'Kosovo','XK'),
(118,'Kuwait','KW'),
(119,'Kyrgyzstan','KG'),
(120,'Laos','LA'),
(121,'Latvia','LV'),
(122,'Lebanon','LB'),
(123,'Lesotho','LS'),
(124,'Liberia','LR'),
(125,'Libya','LY'),
(126,'Liechtenstein','LI'),
(127,'Lithuania','LT'),
(128,'Luxembourg','LU'),
(129,'Macao','MO'),
(130,'Macedonia','MK'),
(131,'Madagascar','MG'),
(132,'Malawi','MW'),
(133,'Malaysia','MY'),
(134,'Maldives','MV'),
(135,'Mali','ML'),
(136,'Malta','MT'),
(137,'Marshall Islands','MH'),
(138,'Martinique','MQ'),
(139,'Mauritania','MR'),
(140,'Mauritius','MU'),
(141,'Mayotte','YT'),
(142,'Mexico','MX'),
(143,'Micronesia','FM'),
(144,'Moldava','MD'),
(145,'Monaco','MC'),
(146,'Mongolia','MN'),
(147,'Montenegro','ME'),
(148,'Montserrat','MS'),
(149,'Morocco','MA'),
(150,'Mozambique','MZ'),
(151,'Myanmar (Burma)','MM'),
(152,'Namibia','NA'),
(153,'Nauru','NR'),
(154,'Nepal','NP'),
(155,'Netherlands','NL'),
(156,'New Caledonia','NC'),
(157,'New Zealand','NZ'),
(158,'Nicaragua','NI'),
(159,'Niger','NE'),
(160,'Nigeria','NG'),
(161,'Niue','NU'),
(162,'Norfolk Island','NF'),
(163,'North Korea','KP'),
(164,'Northern Mariana Islands','MP'),
(165,'Norway','NO'),
(166,'Oman','OM'),
(167,'Pakistan','PK'),
(168,'Palau','PW'),
(169,'Palestine','PS'),
(170,'Panama','PA'),
(171,'Papua New Guinea','PG'),
(172,'Paraguay','PY'),
(173,'Peru','PE'),
(174,'Phillipines','PH'),
(175,'Pitcairn','PN'),
(176,'Poland','PL'),
(177,'Portugal','PT'),
(178,'Puerto Rico','PR'),
(179,'Qatar','QA'),
(180,'Reunion','RE'),
(181,'Romania','RO'),
(182,'Russia','RU'),
(183,'Rwanda','RW'),
(184,'Saint Barthelemy','BL'),
(185,'Saint Helena','SH'),
(186,'Saint Kitts and Nevis','KN'),
(187,'Saint Lucia','LC'),
(188,'Saint Martin','MF'),
(189,'Saint Pierre and Miquelon','PM'),
(190,'Saint Vincent and the Grenadines','VC'),
(191,'Samoa','WS'),
(192,'San Marino','SM'),
(193,'Sao Tome and Principe','ST'),
(194,'Saudi Arabia','SA'),
(195,'Senegal','SN'),
(196,'Serbia','RS'),
(197,'Seychelles','SC'),
(198,'Sierra Leone','SL'),
(199,'Singapore','SG'),
(200,'Sint Maarten','SX'),
(201,'Slovakia','SK'),
(202,'Slovenia','SI'),
(203,'Solomon Islands','SB'),
(204,'Somalia','SO'),
(205,'South Africa','ZA'),
(206,'South Georgia and the South Sandwich Islands','GS'),
(207,'South Korea','KR'),
(208,'South Sudan','SS'),
(209,'Spain','ES'),
(210,'Sri Lanka','LK'),
(211,'Sudan','SD'),
(212,'Suriname','SR'),
(213,'Svalbard and Jan Mayen','SJ'),
(214,'Swaziland','SZ'),
(215,'Sweden','SE'),
(216,'Switzerland','CH'),
(217,'Syria','SY'),
(218,'Taiwan','TW'),
(219,'Tajikistan','TJ'),
(220,'Tanzania','TZ'),
(221,'Thailand','TH'),
(222,'Timor-Leste (East Timor)','TL'),
(223,'Togo','TG'),
(224,'Tokelau','TK'),
(225,'Tonga','TO'),
(226,'Trinidad and Tobago','TT'),
(227,'Tunisia','TN'),
(228,'Turkey','TR'),
(229,'Turkmenistan','TM'),
(230,'Turks and Caicos Islands','TC'),
(231,'Tuvalu','TV'),
(232,'Uganda','UG'),
(233,'Ukraine','UA'),
(234,'United Arab Emirates','AE'),
(235,'United Kingdom','GB'),
(236,'United States','US'),
(237,'United States Minor Outlying Islands','UM'),
(238,'Uruguay','UY'),
(239,'Uzbekistan','UZ'),
(240,'Vanuatu','VU'),
(241,'Vatican City','VA'),
(242,'Venezuela','VE'),
(243,'Vietnam','VN'),
(244,'Virgin Islands, British','VG'),
(245,'Virgin Islands, US','VI'),
(246,'Wallis and Futuna','WF'),
(247,'Western Sahara','EH'),
(248,'Yemen','YE'),
(249,'Zambia','ZM'),
(250,'Zimbabwe','ZW');




CREATE TEMP TABLE MacedoniaCities (
    CityID serial PRIMARY KEY,
    CityName varchar(255) NOT NULL
);

INSERT INTO MacedoniaCities (CityName) VALUES
('Skopje'),
('Bitola'),
('Kumanovo'),
('Prilep'),
('Tetovo'),
('Veles'),
('Ohrid'),
('Gostivar'),
('Strumica'),
('Kavadarci'),
('Struga'),
('Kocani'),
('Kratovo'),
('Kicevo'),
('Negotino'),
('Delcevo'),
('Berovo'),
('Stip'),
('Radovis'),
('Debar'),
('Dolneni'),
('Makedonski Brod'),
('Resen'),
('Krivogashtani'),
('Demir Kapija'),
('Probistip'),
('Sveti Nikole'),
('Valandovo'),
('Bogdanci'),
('Gevgelija'),
('Vinica'),
('Demir Hisar'),
('Vasilevo'),
('Zajas'),
('Rosoman'),
('Pehcevo'),
('Mogila'),
('Makedonska Kamenica'),
('Staro Nagoricane'),
('Sopiste'),
('Oslomej'),
('Dojran'),
('Novaci'),
('Konche'),
('Novo Selo'),
('Vrapciste'),
('Saraj'),
('Mavrovo'),
('Rostusa'),
('Sveti Klement'),
('Lukovo'),
('Vevcani'),
('Lipkovo'),
('Kriva Palanka'),
('Zelenikovo'),
('Vitoliste'),
('Studenicani'),
('Rankovce'),
('Pustec'),
('Plasnica'),
('Orizari'),
('Orasac'),
('Oraovica'),
('Opae'),
('Otovica'),
('Peshkopi'),
('Tearce');

delete from location;

INSERT INTO Location (Name, CountryID)
SELECT CityName, FLOOR(RANDOM() * 250) + 1
FROM MacedoniaCities;

WITH RandomParentIDs AS (
    SELECT ID,
           (CASE WHEN RANDOM() < 0.3 THEN
                     (SELECT ID FROM Location WHERE ID <> l.ID ORDER BY RANDOM() LIMIT 1)
                ELSE NULL
           END) AS ParentID
    FROM Location l
)
UPDATE Location AS l
SET ParentID = rp.ParentID
FROM RandomParentIDs AS rp
WHERE l.ID = rp.ID;





delete from station;

INSERT INTO station (locationid)
SELECT id AS locationid
FROM (
    SELECT id, ROW_NUMBER() OVER () AS row_num
    FROM location
    CROSS JOIN (
        SELECT (random() * 67)::int + 1 AS random_location
        FROM generate_series(1, 1000)  
    ) AS random_loc
) AS loc
WHERE row_num <= 1000;

delete from address;

INSERT INTO address (countryid, street, number, companyid, additionalinfo)
SELECT
    FLOOR(RANDOM() * (SELECT MAX(id) FROM country)) + 1 AS countryid,
    'Street' || floor(random() * 1000)::text || ', ' ||
        (CASE WHEN floor(random() * 2) = 0 THEN 'North' ELSE 'South' END) ||
        ' Avenue' AS street,
    floor(random() * 1000)::text AS number,
    FLOOR(RANDOM() * (SELECT MAX(id) FROM company)) + 1 AS companyid,
    CASE WHEN RANDOM() < 0.4 THEN ' Additional info ' || floor(random() * 1000)::text END AS additionalinfo
FROM generate_series(1, 100);

ALTER TABLE Route ADD CONSTRAINT FKRouteStationStart FOREIGN KEY ("route_start") REFERENCES Station (ID);

 ALTER TABLE Route ADD CONSTRAINT FKRouteStationEnd FOREIGN KEY ("route_end") REFERENCES Station (ID);


WITH AllRoutes AS (
    SELECT
        s1.id AS route_start,
        s2.id AS route_end
    FROM
        station s1
    CROSS JOIN
        station s2
    WHERE
        s1.id != s2.id  
),
RandomRoutes AS (
    SELECT
        route_start,
        route_end,
        ROW_NUMBER() OVER () AS row_num
    FROM
        AllRoutes
    ORDER BY
        random()
)
INSERT INTO route (route_start, route_end, departtime, arrivaltime)
SELECT
    rr.route_start,
    rr.route_end,
    make_time(
        floor(random() * 24)::int,
        floor(random() * 60)::int,
        floor(random() * 60)::int
    ) AS departtime,
    make_time(
        floor(random() * 24)::int,
        floor(random() * 60)::int,
        floor(random() * 60)::int
    ) AS arrivaltime
FROM
    RandomRoutes rr
WHERE
    rr.row_num <= 1000;



UPDATE route
SET
    arrivaltime = date_trunc('minute', arrivaltime) + INTERVAL '1 minute' * round(extract('minute' from arrivaltime)::numeric / 1.0),
    departtime = date_trunc('minute', departtime) + INTERVAL '1 minute' * round(extract('minute' from departtime)::numeric / 1.0);





INSERT INTO route_company (routeid, companyid)
SELECT
    r.id AS routeid,
    c.id AS companyid
FROM
    (SELECT id FROM route ORDER BY RANDOM() LIMIT 100000) AS r
CROSS JOIN LATERAL (
    SELECT id FROM company ORDER BY RANDOM() LIMIT 1
) AS c;


INSERT INTO route_company (routeid, companyid)
SELECT
    r.id AS routeid,
    s_c.id AS companyid
FROM
    (SELECT id FROM route ORDER BY RANDOM() LIMIT 100000) AS r
CROSS JOIN LATERAL (
    SELECT id FROM company ORDER BY RANDOM()
) AS s_c;

DELETE from route_company;

INSERT INTO route_company (routeid, companyid)
SELECT
    routeid,
    companyid
FROM (
    SELECT
        r.id AS routeid,
        COALESCE(c.id, (SELECT id FROM company ORDER BY RANDOM() LIMIT 1)) AS companyid
    FROM
        route r
    LEFT JOIN LATERAL (
        SELECT id FROM company ORDER BY RANDOM() LIMIT floor(random() * 50) + 1
    ) AS c ON TRUE
    ORDER BY RANDOM() 
    LIMIT 1000 
) AS subquery;






INSERT INTO route_company (routeid, companyid)
SELECT
    r.id AS routeid,
    COALESCE(c.id, (SELECT id FROM company ORDER BY RANDOM() LIMIT 1)) AS companyid
FROM
    route r
LEFT JOIN LATERAL (
    SELECT id FROM company ORDER BY RANDOM() LIMIT floor(random() * 100) + 1
) AS c ON TRUE;



INSERT INTO section (routeid, stationid, stationid2, section_order)
SELECT
    r.id AS routeid,
    s1.id AS stationid,
    s2.id AS stationid2,
    ROW_NUMBER() OVER (PARTITION BY r.id ORDER BY s1.id, s2.id) AS section_order
FROM
    route r
CROSS JOIN LATERAL (
    SELECT id FROM station WHERE id <> r.route_start ORDER BY RANDOM() LIMIT 10
) AS s1
CROSS JOIN LATERAL (
    SELECT id FROM station WHERE id <> r.route_end ORDER BY RANDOM() LIMIT 10
) AS s2
LIMIT 10000;



select count(*) from route;


INSERT INTO section (routeid, stationid, stationid2, section_order)
SELECT
    r.id AS routeid,
    s1.id AS stationid,
    s2.id AS stationid2,
    ROW_NUMBER() OVER (PARTITION BY r.id ORDER BY s1.id, s2.id) AS section_order
FROM
    route r
CROSS JOIN LATERAL (
    SELECT id FROM station WHERE id <> r.route_start ORDER BY RANDOM() LIMIT 10
) AS s1
CROSS JOIN LATERAL (
    SELECT id FROM station WHERE id <> r.route_end ORDER BY RANDOM() LIMIT 10
) AS s2
LIMIT 10000;



INSERT INTO section (routeid, stationid, stationid2, section_order)
SELECT
    r.id AS routeid,
    s1.id AS stationid,
    s2.id AS stationid2,
    (ROW_NUMBER() OVER (PARTITION BY r.id ORDER BY s1.id, s2.id) - 1) % 10 + 1 AS section_order
FROM
    route r
CROSS JOIN LATERAL (
    SELECT id FROM station WHERE id <> r.route_start ORDER BY RANDOM() LIMIT 10
) AS s1
CROSS JOIN LATERAL (
    SELECT id FROM station WHERE id <> r.route_end ORDER BY RANDOM() LIMIT 10
) AS s2
LIMIT 10000;


delete from section;

Select count(*) from section;

WITH section_candidates AS (
    SELECT
        r.id AS routeid,
        s1.id AS stationid,
        s2.id AS stationid2,
        ROW_NUMBER() OVER (PARTITION BY r.id ORDER BY s1.id, s2.id) AS rn
    FROM
        route r
    CROSS JOIN LATERAL (
        SELECT id FROM station WHERE id <> r.route_start ORDER BY RANDOM() LIMIT 10
    ) AS s1
    CROSS JOIN LATERAL (
        SELECT id FROM station WHERE id <> r.route_end ORDER BY RANDOM() LIMIT 10
    ) AS s2
)
INSERT INTO section (routeid, stationid, stationid2, section_order)
SELECT
    routeid,
    stationid,
    stationid2,
    ((rn - 1) % 10) + 1 AS section_order
FROM
    section_candidates
WHERE
    rn <= 10
LIMIT 10000;


WITH section_candidates AS (
    SELECT
        r.id AS routeid,
        s1.id AS stationid,
        s2.id AS stationid2,
        ROW_NUMBER() OVER (PARTITION BY r.id ORDER BY s1.id, s2.id) AS rn
    FROM
        route r
    CROSS JOIN LATERAL (
        SELECT id FROM station WHERE id <> r.route_start ORDER BY RANDOM() LIMIT 10
    ) AS s1
    CROSS JOIN LATERAL (
        SELECT id FROM station WHERE id <> r.route_end ORDER BY RANDOM() LIMIT 10
    ) AS s2
),
route_section_count AS (
    SELECT
        routeid,
        (FLOOR(RANDOM() * 2) + 3) AS section_count  
    FROM
        (SELECT DISTINCT routeid FROM section_candidates) routes
),
selected_sections AS (
    SELECT
        sc.routeid,
        sc.stationid,
        sc.stationid2,
        ((sc.rn - 1) % 10) + 1 AS section_order,
        ROW_NUMBER() OVER (ORDER BY sc.routeid, sc.rn) AS overall_rn
    FROM
        section_candidates sc
    JOIN
        route_section_count rsc ON sc.routeid = rsc.routeid
    WHERE
        sc.rn <= rsc.section_count
)
INSERT INTO section (routeid, stationid, stationid2, section_order)
SELECT
    routeid,
    stationid,
    stationid2,
    section_order
FROM
    selected_sections
WHERE
    overall_rn <= 10000;


---- route fix

DO $$
DECLARE
    route RECORD;
BEGIN
    FOR route IN SELECT id FROM Route LOOP
        -- Update each route with a random station as start station
        UPDATE Route r
        SET route_start = (
            SELECT id
            FROM Station
            ORDER BY RANDOM()
            LIMIT 1
        )
        WHERE r.id = route.id;  

    END LOOP;
END $$;

